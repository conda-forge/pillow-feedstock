From d9afb11be92a317de829f82aa175d3cdc572ec8e Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Thu, 11 Nov 2021 20:51:13 +1100
Subject: [PATCH 3/4] Moved macOS SDK logic into a separate method

---
 setup.py | 41 ++++++++++++++++++++++-------------------
 1 file changed, 22 insertions(+), 19 deletions(-)

diff --git a/setup.py b/setup.py
index 341cb331..7655c209 100755
--- a/setup.py
+++ b/setup.py
@@ -405,6 +405,27 @@ class pil_build_ext(build_ext):
                 self.extensions.remove(extension)
                 break
 
+    def get_macos_sdk_path(self):
+        try:
+            sdk_path = (
+                subprocess.check_output(["xcrun", "--show-sdk-path"])
+                .strip()
+                .decode("latin1")
+            )
+        except Exception:
+            sdk_path = None
+        if (
+            not sdk_path
+            or sdk_path == "/Applications/Xcode.app/Contents/Developer"
+            "/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
+        ):
+            commandlinetools_sdk_path = (
+                "/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"
+            )
+            if os.path.exists(commandlinetools_sdk_path):
+                sdk_path = commandlinetools_sdk_path
+        return sdk_path
+
     def build_extensions(self):
 
         library_dirs = []
@@ -532,25 +553,7 @@ class pil_build_ext(build_ext):
                 _add_directory(library_dirs, "/usr/X11/lib")
                 _add_directory(include_dirs, "/usr/X11/include")
 
-            # SDK install path
-            try:
-                sdk_path = (
-                    subprocess.check_output(["xcrun", "--show-sdk-path"])
-                    .strip()
-                    .decode("latin1")
-                )
-            except Exception:
-                sdk_path = None
-            if (
-                not sdk_path
-                or sdk_path == "/Applications/Xcode.app/Contents/Developer"
-                "/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
-            ):
-                commandlinetools_sdk_path = (
-                    "/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"
-                )
-                if os.path.exists(commandlinetools_sdk_path):
-                    sdk_path = commandlinetools_sdk_path
+            sdk_path = self.get_macos_sdk_path()
             if sdk_path:
                 _add_directory(library_dirs, os.path.join(sdk_path, "usr", "lib"))
                 _add_directory(include_dirs, os.path.join(sdk_path, "usr", "include"))
-- 
2.32.0.windows.2

